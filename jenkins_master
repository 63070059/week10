pipeline {
    agent any
    
    environment {
        DOCKER_CONTAINER_NAME1 = "fast-api_container"
        DOCKER_CONTAINER_NAME2 = "frontend_container"

        DOCKER_IMAGE_NAME1     = "fast-api-docker_lab5"
        DOCKER_IMAGE_NAME2     = "frontend"

        PORT_BACKEND           = "8088"
        PORT_FRONTEND          = "5000"
    }

    stages {
            steps {
                echo 'Initial : Delete  containers and images'
                sh 'docker stop ${DOCKER_CONTAINER_NAME} || true'
                sh 'docker rm ${DOCKER_CONTAINER_NAME} || true'
                sh 'docker rmi ${DOCKER_IMAGE_NAME} || true'
              }


        stage('Build Backend') {
            steps {
                    echo "Current path is ${pwd()}"
                    sh "docker build -t ${DOCKER_IMAGE_NAME1} ."
                    dir('frontend') {
                        echo "Current path is ${pwd()}"
                        sh "docker build -t ${DOCKER_IMAGE_NAME2} ."
                    }
                }
            }

        stage('Run Stage') {
            steps {
                sh "docker run -d -p ${PORT_BACKEND}:3000 --name ${DOCKER_CONTAINER_NAME1} ${DOCKER_IMAGE_NAME1}"
                sh "docker run -d -p ${PORT_FRONTEND}:3000 --name ${DOCKER_CONTAINER_NAME2} ${DOCKER_IMAGE_NAME2}"

            }
        }
    }
}